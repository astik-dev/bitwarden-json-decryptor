<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bitwarden JSON Decryptor</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	
	<div class="header">
		<h1>Bitwarden JSON Decryptor</h1>
		<p>Decrypt your password-protected Bitwarden JSON exports locally in your browser</p>
	</div>

	<form class="form">

		<div class="form__input">
			<label for="file-input">Encrypted JSON File</label>
			<input type="file" accept=".json" id="file-input" required>
		</div>

		<div class="form__input">
			<label for="password-input">Master Password</label>
			<input
				type="password"
				id="password-input"
				placeholder="Enter your master password"
				required
			>
			<div class="form__checkbox">
				<input type="checkbox" id="show-password">
				<label for="show-password">Show password</label>
			</div>
		</div>

		<button class="form__button">Decrypt</button>

		<p>All decryption happens locally in your browser. Your password and data never leave your device.</p>
		<p>
			<a
				href="https://github.com/astik-dev/bitwarden-json-decryptor"
				target="_blank"
			>GitHub</a>
		</p>

	</form>

	<div class="success" style="display: none;">
		<p>✅ Decryption successful!</p>
		<a id="download-json-link" download="vault.json">Download Decrypted JSON</a>
		<a id="view-json-link" target="_blank">View Decrypted JSON</a>
	</div>

	<div class="failure" style="display: none;">
		<p>❌ Decryption failed!</p>
		<p id="error-message"></p>
	</div>

	<script src="js/bitwarden-crypto.js"></script>
	<script src="js/decrypt.js"></script>
	
	<script>
		const fileInput = document.getElementById("file-input");
		const passwordInput = document.getElementById("password-input");
		const showPasswordCheckbox = document.getElementById("show-password");

		document.querySelector("form").addEventListener("submit", event => {
			
			event.preventDefault();

			const jsonFile = fileInput.files[0];
			const masterPassword = passwordInput.value;

			const fileReader = new FileReader();

			fileReader.onload = async () => {
				let isDecryptionSuccessful = false;
				try {
					const json = fileReader.result;
					const decryptedJson = 
						await decryptBitwardenJson(json, masterPassword);
					isDecryptionSuccessful = true;
					const blob = new Blob([decryptedJson], {
						type: "application/json",
					});
					const url = URL.createObjectURL(blob);
					document.getElementById("download-json-link").href = url;
					document.getElementById("view-json-link").href = url;
					passwordInput.value = "";
				} catch (error) {
					document.getElementById("error-message").textContent = error;
				} finally {
					document.querySelector(".success").style.display =
						isDecryptionSuccessful ? "" : "none";
					document.querySelector(".failure").style.display =
						isDecryptionSuccessful ? "none" : "";
				}
			};

			fileReader.readAsText(jsonFile);
		});

		showPasswordCheckbox.addEventListener("change", () => {
			passwordInput.type = showPasswordCheckbox.checked ? "text" : "password";
		});
	</script>

</body>
</html>
