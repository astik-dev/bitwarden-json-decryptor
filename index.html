<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bitwarden JSON Decryptor</title>
</head>
<body>
	
	<input type="file" accept=".json">
	<input type="password">
	<button id="decrypt-btn">Decrypt</button>

	<br>
	<br>

	<div style="display: none;">
		<button id="download-json-btn">Download JSON</button>
		<p style="white-space: pre;"></p>
	</div>

	<script src="js/bitwarden-crypto.js"></script>
	<script src="js/decrypt.js"></script>
	
	<script>
		const decryptButton = document.getElementById("decrypt-btn");
		const fileInput = document.querySelector("input[type='file']");
		const passwordInput = document.querySelector("input[type='password']");
		const downloadJsonButton = document.getElementById("download-json-btn");
		const decryptedJsonP = document.querySelector("p");

		decryptButton.addEventListener("click", () => {

			const jsonFile = fileInput.files[0];
			const masterPassword = passwordInput.value;

			const fileReader = new FileReader();

			fileReader.onload = async () => {
				const json = fileReader.result;
				const decryptedJson =
					await decryptBitwardenJson(json, masterPassword);
				decryptedJsonP.textContent = decryptedJson;
				document.querySelector("div").style.display =
					decryptedJson ? "block" : "none";
			};

			fileReader.readAsText(jsonFile);
		});

		downloadJsonButton.addEventListener("click", () => {

			const decryptedJson = decryptedJsonP.textContent;

			const blob = new Blob([decryptedJson], { type: "application/json" });

			const url = URL.createObjectURL(blob);
			const link = document.createElement("a");
			link.href = url;
			link.download = "vault.json";
			link.click();

			URL.revokeObjectURL(url);
		});
	</script>

</body>
</html>
